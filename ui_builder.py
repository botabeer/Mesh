from linebot.v3.messaging import FlexMessage,FlexContainer,QuickReply,QuickReplyItem,MessageAction,TextMessage
from constants import GAME_LIST,DEFAULT_THEME,THEMES,BOT_NAME,BOT_RIGHTS,FIXED_GAME_QR

def _c(t=None):return THEMES.get(t or DEFAULT_THEME,THEMES[DEFAULT_THEME])
def _3d_card(contents,theme=None,padding="20px"):c=_c(theme);return {"type":"box","layout":"vertical","contents":contents,"backgroundColor":c["card"],"cornerRadius":"20px","paddingAll":padding,"borderWidth":"2px","borderColor":c["border"],"margin":"md"}
def _gradient_header(text,theme=None):c=_c(theme);return {"type":"box","layout":"horizontal","contents":[{"type":"text","text":text,"size":"xxl","weight":"bold","color":c["primary"],"flex":1,"align":"center"}],"paddingBottom":"lg"}
def _premium_button(label,text,style="primary",theme=None):c=_c(theme);return {"type":"button","action":{"type":"message","label":label,"text":text},"style":style,"height":"sm","color":c["primary"]if style=="primary"else c["secondary"]}
def _separator_3d(theme=None):c=_c(theme);return {"type":"separator","margin":"lg","color":c["border"]}
def _stat_box(label,value,color_key="primary",theme=None):c=_c(theme);return _3d_card([{"type":"text","text":label,"size":"sm","color":c["text2"],"align":"center"},{"type":"text","text":str(value),"size":"xxl","weight":"bold","color":c[color_key],"align":"center","margin":"sm"}],theme,"15px")
def _flex(alt_text,body):return FlexMessage(alt_text=alt_text,contents=FlexContainer.from_dict(body))
def build_games_quick_reply():return QuickReply(items=[QuickReplyItem(action=MessageAction(label=i["label"],text=i["text"]))for i in FIXED_GAME_QR])
def attach_quick_reply(m):
    if m and hasattr(m,'quick_reply'):m.quick_reply=build_games_quick_reply()
    return m

def build_enhanced_home(username,points,is_registered=True,theme=DEFAULT_THEME,mode_label="ÙØ±Ø¯ÙŠ"):
    c=_c(theme);status="Ù…Ø³Ø¬Ù„"if is_registered else"ØºÙŠØ± Ù…Ø³Ø¬Ù„";join_text="Ø§Ù†Ø³Ø­Ø¨"if is_registered else"Ø§Ù†Ø¶Ù…";next_mode="ÙØ±Ø¯ÙŠ"if mode_label=="ÙØ±ÙŠÙ‚ÙŠÙ†"else"ÙØ±ÙŠÙ‚ÙŠÙ†"
    themes_list=list(THEMES.keys());theme_buttons=[]
    for i in range(0,len(themes_list),3):theme_buttons.append({"type":"box","layout":"horizontal","spacing":"sm","margin":"sm","contents":[_premium_button(t,f"Ø«ÙŠÙ… {t}","primary"if t==theme else"secondary",theme)for t in themes_list[i:i+3]]})
    body={"type":"bubble","size":"mega","body":{"type":"box","layout":"vertical","contents":[_gradient_header(BOT_NAME,theme),_separator_3d(theme),_3d_card([{"type":"box","layout":"horizontal","contents":[{"type":"box","layout":"vertical","contents":[{"type":"text","text":username,"size":"lg","weight":"bold","color":c["text"]},{"type":"text","text":status,"size":"sm","color":c["success"]if is_registered else c["text3"]}],"flex":1}]},{"type":"separator","margin":"md","color":c["border"]},{"type":"box","layout":"horizontal","contents":[{"type":"text","text":"Ø§Ù„Ù†Ù‚Ø§Ø·","size":"md","color":c["text2"],"flex":1},{"type":"text","text":str(points),"size":"xxl","weight":"bold","color":c["primary"],"flex":0}],"margin":"md"}],theme),{"type":"text","text":"Ø§Ø®ØªØ± Ø§Ù„Ø«ÙŠÙ…","size":"lg","weight":"bold","color":c["text"],"margin":"xl"},*theme_buttons,_separator_3d(theme),{"type":"text","text":f"Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {mode_label}","size":"md","weight":"bold","color":c["info"],"align":"center","margin":"md"},{"type":"box","layout":"horizontal","spacing":"sm","margin":"lg","contents":[_premium_button(join_text,join_text,"primary"if is_registered else"secondary",theme),_premium_button("Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨","Ø£Ù„Ø¹Ø§Ø¨","secondary",theme)]},{"type":"box","layout":"horizontal","spacing":"sm","margin":"sm","contents":[_premium_button("Ù†Ù‚Ø§Ø·ÙŠ","Ù†Ù‚Ø§Ø·ÙŠ","secondary",theme),_premium_button("Ø§Ù„ØµØ¯Ø§Ø±Ø©","ØµØ¯Ø§Ø±Ø©","secondary",theme)]},{"type":"box","layout":"horizontal","spacing":"sm","margin":"sm","contents":[_premium_button(next_mode,next_mode,"primary",theme),_premium_button("Ù…Ø³Ø§Ø¹Ø¯Ø©","Ù…Ø³Ø§Ø¹Ø¯Ø©","secondary",theme)]},_separator_3d(theme),{"type":"text","text":BOT_RIGHTS,"size":"xxs","color":c["text3"],"align":"center","wrap":True,"margin":"md"}],"paddingAll":"24px","backgroundColor":c["bg"]}}
    return attach_quick_reply(_flex("Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©",body))

def build_games_menu(theme=DEFAULT_THEME,top_games=None):
    c=_c(theme);default_order=["Ø£Ø³Ø±Ø¹","Ø°ÙƒØ§Ø¡","Ù„Ø¹Ø¨Ø©","Ø®Ù…Ù†","Ø£ØºÙ†ÙŠÙ‡","Ø³Ù„Ø³Ù„Ø©","ØªØ±ØªÙŠØ¨","ØªÙƒÙˆÙŠÙ†","Ø¶Ø¯","Ù„ÙˆÙ†","Ø±ÙŠØ§Ø¶ÙŠØ§Øª","ØªÙˆØ§ÙÙ‚"]
    order=(top_games+[g for g in default_order if g not in top_games])if top_games and len(top_games)>0 else default_order;order=order[:12];game_buttons=[]
    for i in range(0,len(order),3):game_buttons.append({"type":"box","layout":"horizontal","spacing":"sm","margin":"sm","contents":[_premium_button(order[i+j],order[i+j],"primary",theme)for j in range(3)if i+j<len(order)]})
    body={"type":"bubble","size":"mega","body":{"type":"box","layout":"vertical","contents":[_gradient_header("Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ØªØ§Ø­Ø©",theme),{"type":"text","text":"Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹","size":"xs","color":c["text3"],"align":"center"},_separator_3d(theme),*game_buttons,_3d_card([{"type":"text","text":"Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù„Ø¹Ø¨","size":"md","weight":"bold","color":c["text"]},{"type":"text","text":"Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø¨Ø¯Ø¡\nÙ„Ù…Ø­ Ù„Ù„ØªÙ„Ù…ÙŠØ­ | Ø¬Ø§ÙˆØ¨ Ù„Ù„ÙƒØ´Ù\nØ¥ÙŠÙ‚Ø§Ù Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©","size":"xs","color":c["text2"],"wrap":True,"margin":"sm"}],theme,"15px"),{"type":"box","layout":"horizontal","spacing":"sm","margin":"lg","contents":[_premium_button("Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©","Ø¨Ø¯Ø§ÙŠØ©","secondary",theme),_premium_button("Ø¥ÙŠÙ‚Ø§Ù","Ø¥ÙŠÙ‚Ø§Ù","secondary",theme)]},_separator_3d(theme),{"type":"text","text":BOT_RIGHTS,"size":"xxs","color":c["text3"],"align":"center","wrap":True}],"paddingAll":"24px","backgroundColor":c["bg"]}}
    return attach_quick_reply(_flex("Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨",body))

def build_help_window(theme=DEFAULT_THEME):
    c=_c(theme)
    body={"type":"bubble","size":"mega","body":{"type":"box","layout":"vertical","contents":[_gradient_header("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©",theme),_separator_3d(theme),_3d_card([{"type":"text","text":"Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ†Ù‚Ù„","size":"md","weight":"bold","color":c["primary"]},{"type":"text","text":"Ø¨Ø¯Ø§ÙŠØ© | Ø£Ù„Ø¹Ø§Ø¨ | Ù†Ù‚Ø§Ø·ÙŠ | ØµØ¯Ø§Ø±Ø©","size":"sm","color":c["text"],"wrap":True,"margin":"sm"}],theme,"15px"),_3d_card([{"type":"text","text":"Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù„Ø¹Ø¨","size":"md","weight":"bold","color":c["primary"]},{"type":"text","text":"Ù„Ù…Ø­ | Ø¬Ø§ÙˆØ¨ | Ø¥ÙŠÙ‚Ø§Ù","size":"sm","color":c["text"],"wrap":True,"margin":"sm"}],theme,"15px"),_3d_card([{"type":"text","text":"Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø·","size":"md","weight":"bold","color":c["primary"]},{"type":"text","text":"Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©","size":"sm","color":c["text"],"wrap":True,"margin":"sm"}],theme,"15px"),_3d_card([{"type":"text","text":"ÙˆØ¶Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ†","size":"md","weight":"bold","color":c["primary"]},{"type":"text","text":"1. Ø§ÙƒØªØ¨ Ø§Ù†Ø¶Ù…\n2. Ø§Ø¶ØºØ· ÙØ±ÙŠÙ‚ÙŠÙ†\n3. Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø©\n4. ØªÙ‚Ø³ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ","size":"sm","color":c["text"],"wrap":True,"margin":"sm"}],theme,"15px"),_3d_card([{"type":"text","text":"Ø§Ù„ØªÙˆØ§ÙÙ‚","size":"md","weight":"bold","color":c["primary"]},{"type":"text","text":"Ù†Ø¸Ø§Ù… ØªØ±ÙÙŠÙ‡ÙŠ Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø·\nÙ…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹","size":"sm","color":c["text"],"wrap":True,"margin":"sm"}],theme,"15px"),{"type":"box","layout":"horizontal","spacing":"sm","margin":"xl","contents":[_premium_button("Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©","Ø¨Ø¯Ø§ÙŠØ©","primary",theme),_premium_button("Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨","Ø£Ù„Ø¹Ø§Ø¨","secondary",theme)]},_separator_3d(theme),{"type":"text","text":BOT_RIGHTS,"size":"xxs","color":c["text3"],"align":"center","wrap":True}],"paddingAll":"24px","backgroundColor":c["bg"]}}
    return attach_quick_reply(_flex("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©",body))

def build_my_points(username,points,stats=None,theme=DEFAULT_THEME):
    c=_c(theme)
    if points<50:level,level_color="Ù…Ø¨ØªØ¯Ø¦",c["text2"]
    elif points<150:level,level_color="Ù…ØªÙˆØ³Ø·",c["info"]
    elif points<300:level,level_color="Ù…ØªÙ‚Ø¯Ù…",c["warning"]
    else:level,level_color="Ù…Ø­ØªØ±Ù",c["success"]
    body={"type":"bubble","size":"mega","body":{"type":"box","layout":"vertical","contents":[_gradient_header("Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ",theme),_separator_3d(theme),_3d_card([{"type":"text","text":username,"size":"xl","weight":"bold","color":c["text"],"align":"center"},{"type":"box","layout":"horizontal","contents":[_stat_box("Ø§Ù„Ù†Ù‚Ø§Ø·",points,"primary",theme),{"type":"box","layout":"vertical","contents":[{"type":"text","text":"Ø§Ù„Ù…Ø³ØªÙˆÙ‰","size":"sm","color":c["text2"],"align":"center"},{"type":"text","text":level,"size":"lg","weight":"bold","color":level_color,"align":"center","margin":"sm"}],"backgroundColor":c["card"],"cornerRadius":"20px","paddingAll":"15px","borderWidth":"2px","borderColor":c["border"],"margin":"md","flex":1}],"spacing":"sm","margin":"md"}],theme),{"type":"box","layout":"horizontal","spacing":"sm","margin":"xl","contents":[_premium_button("Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©","Ø¨Ø¯Ø§ÙŠØ©","secondary",theme),_premium_button("Ø§Ù„ØµØ¯Ø§Ø±Ø©","ØµØ¯Ø§Ø±Ø©","primary",theme)]},_separator_3d(theme),{"type":"text","text":BOT_RIGHTS,"size":"xxs","color":c["text3"],"align":"center"}],"paddingAll":"24px","backgroundColor":c["bg"]}}
    return attach_quick_reply(_flex("Ù†Ù‚Ø§Ø·ÙŠ",body))

def build_leaderboard(top_users,theme=DEFAULT_THEME):
    c=_c(theme);table_rows=[]
    for i,(name,pts,is_registered)in enumerate(top_users[:20],1):
        status_icon="â—"if is_registered else"â—‹";status_color=c["success"]if is_registered else c["text3"]
        if i<=3:rank_medals=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];rank_text=rank_medals[i-1];rank_color=[c["primary"],c["accent"],c["secondary"]][i-1];row_bg=c["card"];border_width="3px"if i==1 else"2px"
        else:rank_text=str(i);rank_color=c["text2"];row_bg=c["card"];border_width="1px"
        table_rows.append({"type":"box","layout":"horizontal","contents":[{"type":"text","text":rank_text,"size":"lg"if i<=3 else"md","weight":"bold","color":rank_color,"flex":0,"align":"center","gravity":"center"},{"type":"separator","margin":"md","color":c["border"]},{"type":"text","text":name[:20],"size":"md"if i<=3 else"sm","color":c["text"],"flex":4,"margin":"md","wrap":True,"weight":"bold"if i<=3 else"regular"},{"type":"separator","margin":"md","color":c["border"]},{"type":"text","text":str(pts),"size":"lg"if i<=3 else"md","weight":"bold","color":c["primary"],"align":"center","flex":1},{"type":"separator","margin":"md","color":c["border"]},{"type":"text","text":status_icon,"size":"md","color":status_color,"flex":0,"align":"center"}],"paddingAll":"12px","backgroundColor":row_bg,"cornerRadius":"12px","borderWidth":border_width,"borderColor":rank_color if i<=3 else c["border"],"margin":"xs"})
    table_header={"type":"box","layout":"horizontal","contents":[{"type":"text","text":"#","size":"xs","weight":"bold","color":c["text2"],"flex":0,"align":"center"},{"type":"separator","margin":"md","color":c["border"]},{"type":"text","text":"Ø§Ù„Ù„Ø§Ø¹Ø¨","size":"xs","weight":"bold","color":c["text2"],"flex":4,"margin":"md"},{"type":"separator","margin":"md","color":c["border"]},{"type":"text","text":"Ø§Ù„Ù†Ù‚Ø§Ø·","size":"xs","weight":"bold","color":c["text2"],"align":"center","flex":1},{"type":"separator","margin":"md","color":c["border"]},{"type":"text","text":"Ø­Ø§Ù„Ø©","size":"xs","weight":"bold","color":c["text2"],"flex":0,"align":"center"}],"paddingAll":"10px","backgroundColor":c["primary"],"cornerRadius":"12px","margin":"md"}
    body_contents=[_gradient_header("Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©",theme),{"type":"text","text":"Ø£ÙØ¶Ù„ 20 Ù„Ø§Ø¹Ø¨","size":"md","color":c["text2"],"align":"center","margin":"sm"},_separator_3d(theme),table_header,{"type":"box","layout":"vertical","contents":table_rows,"margin":"sm"},_separator_3d(theme),{"type":"text","text":"â— Ù†Ø´Ø· | â—‹ ØºÙŠØ± Ù†Ø´Ø·","size":"xxs","color":c["text3"],"align":"center","wrap":True},{"type":"box","layout":"horizontal","spacing":"sm","margin":"lg","contents":[_premium_button("Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©","Ø¨Ø¯Ø§ÙŠØ©","secondary",theme),_premium_button("Ù†Ù‚Ø§Ø·ÙŠ","Ù†Ù‚Ø§Ø·ÙŠ","primary",theme)]},_separator_3d(theme),{"type":"text","text":BOT_RIGHTS,"size":"xxs","color":c["text3"],"align":"center"}]
    body={"type":"bubble","size":"mega","body":{"type":"box","layout":"vertical","contents":body_contents,"paddingAll":"24px","backgroundColor":c["bg"]}}
    return attach_quick_reply(_flex("Ø§Ù„ØµØ¯Ø§Ø±Ø©",body))

def build_winner_announcement(username,game_name,round_points,total_points,theme=DEFAULT_THEME):
    c=_c(theme)
    body={"type":"bubble","size":"kilo","body":{"type":"box","layout":"vertical","contents":[{"type":"text","text":"Ù…Ø¨Ø±ÙˆÙƒ","size":"xl","weight":"bold","align":"center","color":c["success"]},{"type":"text","text":username,"size":"lg","weight":"bold","color":c["text"],"align":"center","margin":"md"},_separator_3d(theme),{"type":"box","layout":"horizontal","contents":[{"type":"box","layout":"vertical","contents":[{"type":"text","text":"Ø§Ù„Ù†Ù‚Ø§Ø·","size":"xs","color":c["text2"],"align":"center"},{"type":"text","text":f"+{round_points}","size":"xxl","weight":"bold","color":c["primary"],"align":"center"}],"backgroundColor":c["card"],"cornerRadius":"15px","paddingAll":"15px","flex":1}],"margin":"md"},{"type":"text","text":f"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {total_points}","size":"sm","color":c["text2"],"align":"center","margin":"md"},_separator_3d(theme),{"type":"box","layout":"horizontal","spacing":"sm","margin":"md","contents":[_premium_button("Ø¥Ø¹Ø§Ø¯Ø©",game_name,"primary",theme),_premium_button("Ø¥ÙŠÙ‚Ø§Ù","Ø¥ÙŠÙ‚Ø§Ù","secondary",theme)]}],"paddingAll":"20px","backgroundColor":c["bg"]}}
    return attach_quick_reply(_flex("ÙÙˆØ²",body))

def build_team_game_end(team_points,theme=DEFAULT_THEME):
    c=_c(theme);t1,t2=team_points.get("team1",0),team_points.get("team2",0);winner="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„"if t1>t2 else"Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ"if t2>t1 else"ØªØ¹Ø§Ø¯Ù„"
    body={"type":"bubble","size":"mega","body":{"type":"box","layout":"vertical","contents":[_gradient_header("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©",theme),_separator_3d(theme),_3d_card([{"type":"box","layout":"horizontal","contents":[{"type":"text","text":f"Ø§Ù„ÙØ±ÙŠÙ‚ 1\n{t1}","size":"xl","weight":"bold","color":c["primary"],"align":"center","flex":1},{"type":"text","text":"VS","size":"lg","color":c["text2"],"align":"center","flex":0,"weight":"bold"},{"type":"text","text":f"Ø§Ù„ÙØ±ÙŠÙ‚ 2\n{t2}","size":"xl","weight":"bold","color":c["primary"],"align":"center","flex":1}]},{"type":"text","text":f"Ø§Ù„ÙØ§Ø¦Ø²: {winner}","size":"lg","weight":"bold","color":c["success"],"align":"center","margin":"lg"}],theme),{"type":"box","layout":"horizontal","spacing":"sm","margin":"xl","contents":[_premium_button("Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨","Ø£Ù„Ø¹Ø§Ø¨","primary",theme),_premium_button("Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©","Ø¨Ø¯Ø§ÙŠØ©","secondary",theme)]}],"paddingAll":"24px","backgroundColor":c["bg"]}}
    return attach_quick_reply(_flex("Ù†ØªÙŠØ¬Ø©",body))

def build_theme_selector(theme=DEFAULT_THEME):return build_enhanced_home("Ù…Ø³ØªØ®Ø¯Ù…",0,True,theme,"ÙØ±Ø¯ÙŠ")
def build_registration_status(username,points,theme=DEFAULT_THEME):return TextMessage(text=f"ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„\nØ§Ù„Ø§Ø³Ù…: {username}\nØ§Ù„Ù†Ù‚Ø§Ø·: {points}")
def build_registration_required(theme=DEFAULT_THEME):return TextMessage(text="Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨\nØ§ÙƒØªØ¨: Ø§Ù†Ø¶Ù…")
def build_unregister_confirmation(username,points,theme=DEFAULT_THEME):return TextMessage(text=f"ØªÙ… Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨\nÙ†Ù‚Ø§Ø·Ùƒ: {points}")
def build_error_message(error_text,theme=DEFAULT_THEME):return TextMessage(text=f"Ø®Ø·Ø£: {error_text}")
def build_game_stopped(game_name,theme=DEFAULT_THEME):return TextMessage(text=f"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù {game_name}")
def build_answer_feedback(message,theme=DEFAULT_THEME):return TextMessage(text=message)

__all__=['build_enhanced_home','build_games_menu','build_my_points','build_leaderboard','build_help_window','build_registration_status','build_registration_required','build_unregister_confirmation','build_winner_announcement','build_theme_selector','attach_quick_reply','build_error_message','build_game_stopped','build_team_game_end','build_answer_feedback']
