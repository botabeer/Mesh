from flask import Flask, request, abort
import os
import random

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage

from dotenv import load_dotenv
load_dotenv()

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

personal_questions = [
    "من أقرب صديق لك؟","كيف تعرفت على أعز أصدقائك؟","متى حسيت إن الصداقة أهم من أي شيء؟",
    "إيش أجمل موقف صار بينك وبين صديقك؟","هل تؤمن إن الصداقة تدوم طول العمر؟","متى آخر مرة زعلت من صديق؟",
    "هل صديقك أقرب لك من أهلك أحيانًا؟","إيش أكثر صفة تحبها في صديقك؟","إيش أكثر صفة تكرهها في صديقك؟",
    "لو خانك صديقك تسامحه؟","تؤمن بالحب من أول نظرة؟","إيش الحب بالنسبة لك؟","لو خيروك بين المال والحب، تختار أيش؟",
    "هل الحب يغير شخصية الإنسان؟","إيش أكثر شيء يثبت لك إن الشخص يحبك؟","هل الحب بالنسبة لك كلمة ولا فعل؟",
    "أول مرة حبيت كم كان عمرك؟","هل تعتقد أن الحب يجي صدفة؟","هل الغيرة جزء من الحب ولا ضعف؟",
    "هل الحب يختفي مع الوقت؟","إيش طموحك في الحياة؟","إيش أجمل ذكرى في حياتك؟","إيش أصعب موقف مريت فيه؟",
    "متى آخر مرة بكيت وليش؟","إيش الشيء اللي يخوفك أكثر؟","إيش الشيء اللي يسعدك فجأة؟",
    "لو رجع بك الزمن، إيش أول شيء تغيره؟","إيش الشيء اللي ما تقدر تعيش بدونه؟","هل تعتبر نفسك شخص ناجح؟",
    "إيش أكثر يوم ما تنساه؟","تحب تكون قائد ولا تابع؟","إيش أكثر صفة تحبها في نفسك؟","إيش أكثر صفة تكرهها في نفسك؟",
    "هل تعتبر نفسك صريح؟","إيش الشيء اللي يميزك عن غيرك؟","هل عندك عادة غريبة؟","هل تعتبر نفسك اجتماعي؟",
    "إيش الشيء اللي يخليك تضحك بسرعة؟","إيش الشيء اللي يعصبك بسرعة؟","هل تحب المغامرات؟",
    "تحب الليل ولا النهار؟","إيش أول شيء تسويه إذا صحيت من النوم؟","إيش آخر شيء تسويه قبل ما تنام؟",
    "إيش أكثر وقت تحبه باليوم؟","هل تحب السهر ولا تنام بدري؟","إيش أجمل فصل عندك؟","تحب الشتاء ولا الصيف؟",
    "متى تحس بالراحة أكثر؟","متى آخر مرة حسيت بالوحدة؟","متى آخر مرة حسيت بالفخر بنفسك؟",
    "فين تشوف نفسك بعد 5 سنوات؟","إيش أكبر هدف عندك؟","هل تخطط لحياتك ولا تعيش يومك؟",
    "إيش الشيء اللي تتمنى تحققه قريب؟","إيش الحلم اللي للحين ما تحقق؟","لو معك 3 أمنيات، إيش تتمنى؟",
    "هل تفكر بالزواج قريب؟","إيش أكثر شي يشغلك عن مستقبلك؟","هل تحب تجازف ولا تفضل الأمان؟",
    "إيش أكثر شيء تخاف تفشل فيه؟","إيش أكثر أكل تحبه؟","إيش أكثر لون تحبه؟","إيش أكثر فيلم أو مسلسل تحبه؟",
    "إيش آخر كتاب قريته؟","إيش أكثر تطبيق تستخدمه؟","إيش أكثر كلمة تقولها دايم؟",
    "لو ربحت مليون، إيش أول شيء تسويه؟","إيش أكثر مكان ترتاح فيه؟","هل تحب السفر؟","إيش أكثر بلد ودك تزوره؟",
    "لو رجعت لطفولتك، إيش أول شيء تسويه؟","إيش أكثر لعبة كنت تلعبها وأنت صغير؟","إيش أجمل هدية جتك؟",
    "إيش الشيء اللي يخليك تبتسم؟","من الشخص اللي تثق فيه ثقة عمياء؟","إيش أكثر شخص تعتمد عليه؟",
    "إيش أكثر شخص تحب تكلمه كل يوم؟","إيش أكثر عادة حلوة فيك؟","إيش أكثر عادة سيئة فيك؟",
    "إيش أكثر شيء تحب تبدأ فيه يومك؟","إيش الشيء اللي مستحيل تسامح فيه؟","إيش الشيء اللي يخليك تحزن بسرعة؟",
    "إيش الشيء اللي يخليك تفرح بسرعة؟","لو رجعت يوم واحد من الماضي، أي يوم تختار؟","إيش أكثر شخص تتمنى تشوفه الآن؟",
    "إيش أكثر موقف مضحك صار لك؟","إيش أكثر موقف حزين صار لك؟","إيش الشيء اللي يذكرك بالماضي؟",
    "إيش أكثر قناة كنت تتابعها وأنت صغير؟","إيش الشيء اللي تحب تشتريه دايم؟"
]

@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers["X-Line-Signature"]
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return "OK"

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    text = event.message.text.strip()

    # الكلمات الصحيحة والأخطاء الشائعة
    trigger_words = [
        "سؤال", "سوال",
        "أسئلة", "اسئلة", "اسأله", "اساله", "أساله", "أسالة"
    ]

    if text in trigger_words:
        questions = random.sample(personal_questions, 10)
        reply = "\n".join(questions)
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=reply)
        )

if __name__ == "__main__":
    app.run(port=5000)
