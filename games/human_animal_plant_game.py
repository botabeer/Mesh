"""
ูุนุจุฉ ุฅูุณุงู ุญููุงู ูุจุงุช ุฌูุงุฏ ุจูุงุฏ - Enhanced Version
Created by: Abeer Aldosari ยฉ 2025
"""
from linebot.models import TextSendMessage
from .base_game import BaseGame
import random


class HumanAnimalPlantGame(BaseGame):
    """ูุนุจุฉ ุฅูุณุงู ุญููุงู ูุจุงุช ุฌูุงุฏ ุจูุงุฏ - ูุญุณููุฉ"""
    
    def __init__(self, line_bot_api, use_ai=False, get_api_key=None, switch_key=None):
        super().__init__(line_bot_api, questions_count=10)
        
        # ุงูุญุฑูู ุงูุดุงุฆุนุฉ ูุงูุณููุฉ
        self.letters = list("ุงุจุชุฌุญุฏุฑุฒุณุดุตุทุนููููููููู")
        random.shuffle(self.letters)
        
        # ุงููุฆุงุช
        self.categories = ["ุฅูุณุงู", "ุญููุงู", "ูุจุงุช", "ุฌูุงุฏ", "ุจูุงุฏ"]
        self.current_category = None
        self.current_letter = None
        
        # ูุงุนุฏุฉ ุจูุงูุงุช ููุณูุนุฉ
        self.answers_db = {
            "ุฅูุณุงู": {
                "ุฃ": ["ุฃุญูุฏ", "ุฃูู", "ุฃุณุงูุฉ", "ุฃููุฑ", "ุฅุจุฑุงููู", "ุฃุณูุงุก"],
                "ุจ": ["ุจุฏุฑ", "ุจุณูุฉ", "ุจุงุณู", "ุจุดุฑู", "ุจูุงู"],
                "ุช": ["ุชุงูุฑ", "ุชุงูุง", "ุชุฑูู"],
                "ุฌ": ["ุฌูุงู", "ุฌูููุฉ", "ุฌุงุจุฑ", "ุฌูุงุฏ"],
                "ุญ": ["ุญุณู", "ุญูุงู", "ุญุงูุฏ", "ุญูููุฉ"],
                "ุฏ": ["ุฏุงูุฏ", "ุฏุงูุง", "ุฏููุง", "ุฏูุงู"],
                "ุฑ": ["ุฑุงูู", "ุฑูุง", "ุฑุงุดุฏ", "ุฑูู"],
                "ุฒ": ["ุฒูุฏ", "ุฒููุจ", "ุฒูุงุฏ", "ุฒูุฑุฉ"],
                "ุณ": ["ุณุงุฑุฉ", "ุณุนูุฏ", "ุณุงูู", "ุณููู", "ุณูููุงู"],
                "ุด": ["ุดุงุฏู", "ุดููุงุก", "ุดูุฏ"],
                "ุต": ["ุตุงูุญ", "ุตูุงุก", "ุตุงุจุฑ"],
                "ุท": ["ุทุงุฑู", "ุทูุงู"],
                "ุน": ["ุนูู", "ุนูุฑ", "ุนุงุฆุดุฉ", "ุนุจุฏุงููู", "ุนูุงุฏ"],
                "ู": ["ูุงุทูุฉ", "ููุฏ", "ููุตู", "ูุฑูุฏ"],
                "ู": ["ูุงุณู", "ูุตู"],
                "ู": ["ูุฑูู", "ููุงู"],
                "ู": ["ูููู", "ูุทููุฉ", "ูุคู", "ูููุง"],
                "ู": ["ูุญูุฏ", "ูุฑูู", "ูุงุฌุฏ", "ููู", "ูุตุทูู"],
                "ู": ["ููุฑ", "ูุงุฏุฑ", "ููู", "ูุงูู"],
                "ู": ["ููุฏ", "ูุงูู", "ูุฏู", "ูุดุงู"],
                "ู": ["ูููุฏ", "ููุงุก", "ูุณุงู"],
                "ู": ["ููุณู", "ูุงุณุฑ", "ูุงุณููู", "ูุงุฑุง"]
            },
            "ุญููุงู": {
                "ุฃ": ["ุฃุณุฏ", "ุฃุฑูุจ", "ุฃูุนู", "ุฃุฎุทุจูุท"],
                "ุจ": ["ุจูุฑุฉ", "ุจุทุฉ", "ุจุจุบุงุก", "ุจุฌุนุฉ"],
                "ุฌ": ["ุฌูู", "ุฌุงููุณ", "ุฌุฑุงุฏ"],
                "ุฏ": ["ุฏุฌุงุฌุฉ", "ุฏูู", "ุฏุจ", "ุฏูุฏุฉ", "ุฏูููู"],
                "ุฐ": ["ุฐุฆุจ", "ุฐุจุงุจุฉ"],
                "ุฒ": ["ุฒุฑุงูุฉ", "ุฒูุงุญู"],
                "ุณ": ["ุณููุฉ", "ุณูุญูุงุฉ", "ุณูุฌุงุจ", "ุณุญููุฉ"],
                "ุด": ["ุดุงุฉ", "ุดุจู"],
                "ุท": ["ุทุงููุณ", "ุทุงุฆุฑ"],
                "ุน": ["ุนุตููุฑ", "ุนูุฑุจ", "ุนููุจูุช"],
                "ู": ["ููู", "ูุฃุฑ", "ููุฏ", "ูุฑุงุดุฉ"],
                "ู": ["ูุท", "ูุฑุฏ", "ูููุฐ"],
                "ู": ["ููุจ", "ููุบุฑ"],
                "ู": ["ููุซ", "ูุจุคุฉ"],
                "ู": ["ููุฑ", "ูุณุฑ", "ูุญูุฉ", "ููู", "ูุนุงูุฉ"],
                "ู": ["ูุฏูุฏ", "ูุฑ"],
                "ู": ["ูุฒุฉ", "ูุทูุงุท"],
                "ู": ["ููุงูุฉ"]
            },
            "ูุจุงุช": {
                "ุช": ["ุชูุงุญ", "ุชูุช", "ุชูู", "ุชูุฑ"],
                "ุฌ": ["ุฌูุฒ", "ุฌุฒุฑ"],
                "ุญ": ["ุญูุต"],
                "ุฑ": ["ุฑูุงู", "ุฑูุญุงู", "ุฑุฒ"],
                "ุฒ": ["ุฒูุชูู", "ุฒุนุชุฑ", "ุฒูุฌุจูู"],
                "ุณ": ["ุณูุฑุฌู"],
                "ุด": ["ุดุนูุฑ", "ุดูุงู"],
                "ุท": ["ุทูุงุทู"],
                "ุน": ["ุนูุจ", "ุนุฏุณ"],
                "ู": ["ููู", "ูุฌู", "ูููู"],
                "ู": ["ููุญ", "ูุฑุน"],
                "ู": ["ูููู", "ูุฑูู"],
                "ู": ["ููููู", "ููุฒ"],
                "ู": ["ููุฒ", "ูุงูุฌู", "ูููุฎูุฉ"],
                "ู": ["ูุฎู", "ูุนูุงุน"],
                "ู": ["ูุฑุฏ", "ูุฑู"],
                "ู": ["ููุทูู"]
            },
            "ุฌูุงุฏ": {
                "ุจ": ["ุจุงุจ", "ุจูุช", "ุจุฑุฌ"],
                "ุช": ["ุชููุงุฒ", "ุชุฑุงุจูุฒุฉ", "ุชุงุฌ"],
                "ุฌ": ["ุฌุฏุงุฑ", "ุฌุณุฑ"],
                "ุญ": ["ุญุฌุฑ", "ุญุงุฆุท"],
                "ุฏ": ["ุฏุฑุฌ"],
                "ุฑ": ["ุฑู"],
                "ุณ": ["ุณุฑูุฑ", "ุณูุงุฑุฉ", "ุณููู"],
                "ุด": ["ุดุจุงู", "ุดุงุดุฉ"],
                "ุท": ["ุทุงููุฉ", "ุทุจู"],
                "ู": ["ูุงููุณ"],
                "ู": ["ููู"],
                "ู": ["ูุชุงุจ", "ูุฑุณู", "ููุจ"],
                "ู": ["ููุชุงุญ", "ููุชุจ", "ูุตุจุงุญ", "ูุฑูุญุฉ"],
                "ู": ["ูุงูุฐุฉ"],
                "ู": ["ูุงุชู"]
            },
            "ุจูุงุฏ": {
                "ุฃ": ["ุงูุฃุฑุฏู", "ุงูุฅูุงุฑุงุช", "ุฅุซููุจูุง", "ุฃูุบุงูุณุชุงู"],
                "ุจ": ["ุงูุจุญุฑูู", "ุจุฑูุทุงููุง"],
                "ุช": ["ุชููุณ", "ุชุฑููุง", "ุชุงููุงูุฏ"],
                "ุฌ": ["ุงูุฌุฒุงุฆุฑ", "ุฌูุจูุชู"],
                "ุณ": ["ุงูุณุนูุฏูุฉ", "ุณูุฑูุง", "ุงูุณูุฏุงู", "ุงูุณููุฏ"],
                "ุด": ["ุงูุดุงู"],
                "ุน": ["ุนูุงู", "ุงูุนุฑุงู"],
                "ู": ["ููุณุทูู", "ูุฑูุณุง", "ููุฒูููุง"],
                "ู": ["ูุทุฑ"],
                "ู": ["ุงููููุช", "ููุฏุง"],
                "ู": ["ูุจูุงู", "ููุจูุง"],
                "ู": ["ูุตุฑ", "ุงููุบุฑุจ", "ูุงููุฒูุง", "ููุฑูุชุงููุง"],
                "ู": ["ุงููุฑููุฌ"],
                "ู": ["ููููุฏุง", "ุงูููุฏ"],
                "ู": ["ุงูููู", "ุงููุงุจุงู"]
            }
        }
    
    def start_game(self):
        """ุจุฏุก ุงููุนุจุฉ"""
        self.current_question = 0
        self.game_active = True
        return self.get_question()
    
    def get_question(self):
        """ุงูุญุตูู ุนูู ุงูุณุคุงู ุงูุญุงูู"""
        # ุงุฎุชูุงุฑ ุญุฑู ููุฆุฉ ุนุดูุงุฆูุงู
        self.current_letter = self.letters[self.current_question % len(self.letters)]
        self.current_category = random.choice(self.categories)
        
        message = f"๐ฏ ุฅูุณุงู ุญููุงู ูุจุงุช ({self.current_question + 1}/{self.questions_count})\n\n"
        message += f"๐ค ุงูุญุฑู: {self.current_letter}\n"
        message += f"๐ ุงููุฆุฉ: {self.current_category}\n\n"
        message += f"โ๏ธ ุงูุชุจ {self.current_category} ูุจุฏุฃ ุจุญุฑู {self.current_letter}\n\n"
        message += "โข ุฌุงูุจ - ูุนุฑุถ ุฅุฌุงุจุฉ ููุชุฑุญุฉ"
        
        return TextSendMessage(text=message)
    
    def check_answer(self, user_answer, user_id, display_name):
        """ูุญุต ุงูุฅุฌุงุจุฉ"""
        if not self.game_active:
            return None
        
        if user_id in self.answered_users:
            return None
        
        # ุฃูุฑ ุฌุงูุจ
        if user_answer == 'ุฌุงูุจ':
            suggested = None
            if self.current_category in self.answers_db:
                if self.current_letter in self.answers_db[self.current_category]:
                    answers_list = self.answers_db[self.current_category][self.current_letter]
                    if answers_list:
                        suggested = random.choice(answers_list)
            
            if suggested:
                reveal = f"๐ก ุฅุฌุงุจุฉ ููุชุฑุญุฉ: {suggested}"
            else:
                reveal = f"๐ก ุฃู ูููุฉ ุชุจุฏุฃ ุจุญุฑู {self.current_letter}"
            
            next_q = self.next_question()
            
            if isinstance(next_q, dict) and next_q.get('game_over'):
                next_q['message'] = f"{reveal}\n\n{next_q.get('message', '')}"
                return next_q
            
            message = f"{reveal}\n\n"
            if hasattr(next_q, 'text'):
                message += next_q.text
            
            return {
                'message': message,
                'response': TextSendMessage(text=message),
                'points': 0
            }
        
        # ุชุทุจูุน ุงูุฅุฌุงุจุฉ
        normalized_answer = self.normalize_text(user_answer)
        normalized_letter = self.normalize_text(self.current_letter)
        
        # ุงูุชุญูู ูู ุฃู ุงูุฅุฌุงุจุฉ ุชุจุฏุฃ ุจุงูุญุฑู ุงูุตุญูุญ
        if not normalized_answer or not normalized_answer[0] == normalized_letter:
            return {
                'message': f"โ๏ธ ูุฌุจ ุฃู ุชุจุฏุฃ ุงููููุฉ ุจุญุฑู {self.current_letter}",
                'response': TextSendMessage(text=f"โ๏ธ ูุฌุจ ุฃู ุชุจุฏุฃ ุงููููุฉ ุจุญุฑู {self.current_letter}"),
                'points': 0
            }
        
        # ุงูุชุญูู ูู ุทูู ุงููููุฉ (ุนูู ุงูุฃูู ุญุฑููู)
        if len(normalized_answer) < 2:
            return {
                'message': "โ๏ธ ุงููููุฉ ูุตูุฑุฉ ุฌุฏุงู",
                'response': TextSendMessage(text="โ๏ธ ุงููููุฉ ูุตูุฑุฉ ุฌุฏุงู"),
                'points': 0
            }
        
        # ูุจูู ุงูุฅุฌุงุจุฉ ุงูููุทููุฉ
        points = self.add_score(user_id, display_name, 10)
        next_q = self.next_question()
        
        if isinstance(next_q, dict) and next_q.get('game_over'):
            next_q['points'] = points
            return next_q
        
        message = f"โ ุฅุฌุงุจุฉ ููุจููุฉ ูุง {display_name}!\n+{points} ููุทุฉ\n\n"
        if hasattr(next_q, 'text'):
            message += next_q.text
        
        return {
            'message': message,
            'response': TextSendMessage(text=message),
            'points': points
        }
