"""
ğŸ§  Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ - Bot Mesh v3.2 (Ù†Ø³Ø®Ø© Ù…Ø¯Ù’Ù…ÙØ¬Ø© ÙØ±ÙŠÙ‚ÙŠÙ† + ØªÙˆÙ‚ÙŠØª)
Created by: Abeer Aldosari Â© 2025
"""

from games.base_game import BaseGame
import random
from typing import Dict, Any, Optional
import time


class IqGame(BaseGame):
    """Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© - ÙØ±Ø¯ÙŠ + ÙØ±ÙŠÙ‚ÙŠÙ† + Ù†Ù‚Ø§Ø· Ø²Ù…Ù†ÙŠØ©"""

    def __init__(self, line_bot_api):
        super().__init__(line_bot_api, questions_count=5)
        self.game_name = "Ø°ÙƒØ§Ø¡"
        self.game_icon = "ğŸ§ "

        self.round_time = 25  # â±ï¸ Ø²Ù…Ù† Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
        self.round_start_time = None
        
        # Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ù„ØºØ§Ø² + 50 Ù…Ø«Ø§Ù„ Ø¥Ø¶Ø§ÙÙŠ
        self.riddles = [
            {"q": "Ù…Ø§ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø´ÙŠ Ø¨Ù„Ø§ Ø£Ø±Ø¬Ù„ ÙˆÙŠØ¨ÙƒÙŠ Ø¨Ù„Ø§ Ø¹ÙŠÙˆÙ†ØŸ", "a": ["Ø§Ù„Ø³Ø­Ø§Ø¨", "Ø§Ù„ØºÙŠÙ…", "Ø³Ø­Ø§Ø¨", "ØºÙŠÙ…"]},
            {"q": "Ù„Ù‡ Ø±Ø£Ø³ ÙˆÙ„ÙƒÙ† Ù„Ø§ Ø¹ÙŠÙ† Ù„Ù‡ØŸ", "a": ["Ø§Ù„Ø¯Ø¨ÙˆØ³", "Ø§Ù„Ù…Ø³Ù…Ø§Ø±", "Ø§Ù„Ø¥Ø¨Ø±Ø©"]},
            {"q": "Ø´ÙŠØ¡ ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯ Ù†Ù‚ØµØŸ", "a": ["Ø§Ù„Ø¹Ù…Ø±", "Ø§Ù„ÙˆÙ‚Øª"]},
            {"q": "ÙŠÙƒØªØ¨ ÙˆÙ„Ø§ ÙŠÙ‚Ø±Ø£ Ø£Ø¨Ø¯Ø§Ù‹ØŸ", "a": ["Ø§Ù„Ù‚Ù„Ù…"]},
            {"q": "Ù„Ù‡ Ø£Ø³Ù†Ø§Ù† ÙƒØ«ÙŠØ±Ø© ÙˆÙ„ÙƒÙ†Ù‡ Ù„Ø§ ÙŠØ¹Ø¶ØŸ", "a": ["Ø§Ù„Ù…Ø´Ø·"]},
            {"q": "ÙŠÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„Ù…Ø§Ø¡ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø§Ø¡ ÙŠÙ…ÙŠØªÙ‡ØŸ", "a": ["Ø§Ù„Ù…Ù„Ø­"]},
            {"q": "ÙŠØªÙƒÙ„Ù… Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª Ø¯ÙˆÙ† Ø£Ù† ÙŠØªØ¹Ù„Ù…Ù‡Ø§ØŸ", "a": ["Ø§Ù„ØµØ¯Ù‰"]},
            {"q": "Ø´ÙŠØ¡ ÙƒÙ„Ù…Ø§ Ø£Ø®Ø°Øª Ù…Ù†Ù‡ ÙƒØ¨Ø±ØŸ", "a": ["Ø§Ù„Ø­ÙØ±Ø©"]},
            {"q": "ÙŠØ®ØªØ±Ù‚ Ø§Ù„Ø²Ø¬Ø§Ø¬ ÙˆÙ„Ø§ ÙŠÙƒØ³Ø±Ù‡ØŸ", "a": ["Ø§Ù„Ø¶ÙˆØ¡", "Ø§Ù„Ù†ÙˆØ±"]},
            {"q": "ÙŠØ³Ù…Ø¹ Ø¨Ù„Ø§ Ø£Ø°Ù† ÙˆÙŠØªÙƒÙ„Ù… Ø¨Ù„Ø§ Ù„Ø³Ø§Ù†ØŸ", "a": ["Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„Ø¬ÙˆØ§Ù„"]},

            # â–ªï¸ 50 Ù„ØºØ² Ø¥Ø¶Ø§ÙÙŠ
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ØªØ±Ø§Ù‡ ÙˆÙ„Ø§ ØªØ³ØªØ·ÙŠØ¹ Ù„Ù…Ø³Ù‡ØŸ", "a": ["Ø§Ù„Ø¸Ù„"]},
            {"q": "Ø´ÙŠØ¡ Ø¥Ø°Ø§ Ø£Ø®Ø°Øª Ù…Ù†Ù‡ ÙƒØ¨Ø±ØŸ", "a": ["Ø§Ù„Ø­ÙØ±Ø©"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø´ÙŠ Ø¨Ù„Ø§ Ù‚Ø¯Ù…ÙŠÙ†ØŸ", "a": ["Ø§Ù„ÙˆÙ‚Øª"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø§Ù„Ù…Ø§Ø¡ Ù„Ø§ ÙŠØ¨ØªÙ„ØŸ", "a": ["Ø§Ù„Ø¶ÙˆØ¡"]},
            {"q": "Ù„Ù‡ Ø¹ÙŠÙ†Ø§Ù† ÙˆÙ„Ø§ ÙŠØ±Ù‰ØŸ", "a": ["Ø§Ù„Ù…Ù‚Øµ"]},
            {"q": "Ø£Ø®Ø¶Ø± ÙÙŠ Ø§Ù„Ø£Ø±Ø¶ ÙˆØ£Ø³ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ ÙˆØ£Ø­Ù…Ø± ÙÙŠ Ø§Ù„Ø¨ÙŠØªØŸ", "a": ["Ø§Ù„Ø´Ø§ÙŠ"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠÙ…Ø´ÙŠ Ø¥Ù„Ø§ Ø¨Ø§Ù„Ø¶Ø±Ø¨ØŸ", "a": ["Ø§Ù„Ù…Ø³Ù…Ø§Ø±"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ø¥Ø°Ø§ Ù‚Ø·Ø¹ØªÙ‡ ÙƒØ¨Ø±ØŸ", "a": ["Ø§Ù„Ø­Ø¨Ù„"]},
            {"q": "Ù„Ù‡ Ø£ÙˆØ±Ø§Ù‚ ÙˆÙ„ÙŠØ³ Ø´Ø¬Ø±Ø§Ù‹ØŸ", "a": ["Ø§Ù„ÙƒØªØ§Ø¨"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø±ØµÙƒ ÙˆÙ„Ø§ ØªØ±Ø§Ù‡ØŸ", "a": ["Ø§Ù„Ø¬ÙˆØ¹"]},

            {"q": "ÙŠÙ…ØªÙ„Ø¦ Ø¨Ø§Ù„Ø«Ù‚ÙˆØ¨ ÙˆÙŠØ­ÙØ¸ Ø§Ù„Ù…Ø§Ø¡ØŸ", "a": ["Ø§Ù„Ø¥Ø³ÙÙ†Ø¬"]},
            {"q": "ÙŠØ³ÙŠØ± Ø¨Ù„Ø§ Ù‚Ø¯Ù…ÙŠÙ† ÙˆÙŠØ¯Ø®Ù„ Ø§Ù„Ø£Ø°Ù†ÙŠÙ†ØŸ", "a": ["Ø§Ù„ØµÙˆØª"]},
            {"q": "ÙŠÙˆÙ„Ø¯ ÙƒØ¨ÙŠØ±Ø§Ù‹ ÙˆÙŠÙ…ÙˆØª ØµØºÙŠØ±Ø§Ù‹ØŸ", "a": ["Ø§Ù„Ø´Ù…Ø¹Ø©"]},
            {"q": "Ù„Ù‡ Ø±Ù‚Ø¨Ø© ÙˆÙ„ÙŠØ³ Ù„Ù‡ Ø±Ø£Ø³ØŸ", "a": ["Ø§Ù„Ø²Ø¬Ø§Ø¬Ø©"]},
            {"q": "ØªØ³ØªØ·ÙŠØ¹ ÙƒØ³Ø±Ù‡ Ø¯ÙˆÙ† Ù„Ù…Ø³Ù‡ØŸ", "a": ["Ø§Ù„ÙˆØ¹Ø¯"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠÙ†Ø§Ù… ÙˆÙ„Ø§ ÙŠØ³ØªÙŠÙ‚Ø¸ØŸ", "a": ["Ø§Ù„Ù…ÙˆØª"]},
            {"q": "ÙŠÙƒØªØ¨ ÙˆÙ„Ø§ ÙŠÙ‚Ø±Ø£ØŸ", "a": ["Ø§Ù„Ù‚Ù„Ù…"]},
            {"q": "Ø£Ø¨ÙŠØ¶ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ ÙˆØ£Ø³ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø±ØŸ", "a": ["Ø§Ù„Ø·Ø±ÙŠÙ‚"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØªÙƒÙ„Ù… ÙˆÙ„ÙƒÙ† Ø¥Ø°Ø§ Ø¶Ø±Ø¨ØªÙ‡ ØµØ§Ø­ØŸ", "a": ["Ø§Ù„Ø¬Ø±Ø³"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ø¥Ø°Ø§ Ø³Ù…ÙŠØª ÙƒØ³Ø±ØŸ", "a": ["Ø§Ù„ØµÙ…Øª"]},

            {"q": "Ù„Ù‡ Ø£Ø³Ù†Ø§Ù† ÙˆÙ„Ø§ ÙŠØ¹Ø¶ØŸ", "a": ["Ø§Ù„Ù…Ø´Ø·"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ØªØ°Ø¨Ø­Ù‡ ÙˆØªØ¨ÙƒÙŠ Ø¹Ù„ÙŠÙ‡ØŸ", "a": ["Ø§Ù„Ø¨ØµÙ„"]},
            {"q": "ÙŠØ·ÙŠØ± Ø¨Ù„Ø§ Ø£Ø¬Ù†Ø­Ø©ØŸ", "a": ["Ø§Ù„ÙˆÙ‚Øª"]},
            {"q": "ÙŠØ³ÙŠØ± Ø¨Ù„Ø§ Ø¹ÙŠÙˆÙ†ØŸ", "a": ["Ø§Ù„Ù…Ø§Ø¡"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ÙƒÙ„Ù…Ø§ ÙƒØ¨Ø± ØµØºØ±ØŸ", "a": ["Ø§Ù„Ø¹Ù…Ø±"]},
            {"q": "ÙŠØ£ÙƒÙ„ ÙˆÙ„Ø§ ÙŠØ´Ø¨Ø¹ØŸ", "a": ["Ø§Ù„Ù†Ø§Ø±"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ØªØ±Ø§Ù‡ ÙˆÙ„Ø§ ØªÙ…Ø³ÙƒÙ‡ØŸ", "a": ["Ø§Ù„Ù‡ÙˆØ§Ø¡"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø´ÙŠ ÙˆÙŠÙ‚Ù ÙˆÙ„ÙŠØ³ Ù„Ù‡ Ø£Ù‚Ø¯Ø§Ù…ØŸ", "a": ["Ø§Ù„Ø³Ø§Ø¹Ø©"]},
            {"q": "Ù„Ù‡ Ù…ÙØªØ§Ø­ ÙˆÙ„Ø§ ÙŠÙØªØ­ØŸ", "a": ["Ø§Ù„Ø¨ÙŠØ§Ù†Ùˆ"]},
            {"q": "ÙŠØªØ­Ø±Ùƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­ÙˆÙ„Ùƒ ÙˆÙ„Ø§ ØªØ´Ø¹Ø± Ø¨Ù‡ØŸ", "a": ["Ø§Ù„Ù‡ÙˆØ§Ø¡"]},

            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø´ÙŠ Ø¨Ù„Ø§ Ù‚Ø¯Ù…ÙŠÙ† ÙˆÙŠØ¨ÙƒÙŠ Ø¨Ù„Ø§ Ø¹ÙŠÙ†ØŸ", "a": ["Ø§Ù„Ø³Ø­Ø§Ø¨"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ø¥Ø°Ø§ Ø£Ø®Ø°Øª Ù…Ù†Ù‡ ÙƒØ«ÙŠØ±Ø§Ù‹ ÙŠØ¨Ù‚Ù‰ Ù‚Ù„ÙŠÙ„Ø§Ù‹ØŸ", "a": ["Ø§Ù„Ø¹Ù…Ø±"]},
            {"q": "ÙŠÙ…ØªÙ„Ø¦ ÙƒÙ„Ù…Ø§ Ù†Ù‚ØµØŸ", "a": ["Ø§Ù„Ø¹Ù…Ø±"]},
            {"q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ø¥Ø°Ø§ Ø£ÙƒÙ„ØªÙ‡ ÙƒÙ„Ù‡ ØªØ³ØªÙÙŠØ¯ØŸ", "a": ["Ø§Ù„Ø³Ù…Ø³Ù…"]},
            {"q": "ÙŠÙØ±Ù‰ ÙˆÙ„Ø§ ÙŠÙÙ…Ø³ØŸ", "a": ["Ø§Ù„Ø¸Ù„"]}
        ]

        random.shuffle(self.riddles)
        self.used_riddles = []

    def start_game(self):
        self.current_question = 0
        self.game_active = True
        self.used_riddles = []
        self.previous_question = None
        self.previous_answer = None
        self.answered_users.clear()
        return self.get_question()

    def get_question(self):
        available = [r for r in self.riddles if r not in self.used_riddles]
        if not available:
            self.used_riddles = []
            available = self.riddles.copy()

        riddle = random.choice(available)
        self.used_riddles.append(riddle)
        self.current_answer = riddle["a"]

        self.round_start_time = time.time()

        return self.build_question_flex(
            question_text=f"ğŸ§© {riddle['q']}",
            additional_info="â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ù…Ø­Ø¯ÙˆØ¯ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©"
        )

    def check_answer(self, user_answer: str, user_id: str, display_name: str) -> Optional[Dict[str, Any]]:
        if not self.game_active or user_id in self.answered_users:
            return None

        elapsed = int(time.time() - self.round_start_time)
        remaining = max(0, self.round_time - elapsed)

        normalized = self.normalize_text(user_answer)

        for correct in self.current_answer:
            if self.normalize_text(correct) == normalized:
                base_points = 10
                time_bonus = max(0, remaining // 3)
                total_points = base_points + time_bonus

                if self.is_team_mode:
                    team = self.get_user_team(user_id)
                    self.add_team_score(team, total_points)
                else:
                    self.add_score(user_id, display_name, total_points)

                self.previous_question = self.used_riddles[-1]["q"]
                self.previous_answer = correct

                self.current_question += 1
                self.answered_users.clear()

                if self.current_question >= self.questions_count:
                    return self.end_game()

                return {
                    "message": f"âœ… ØµØ­ÙŠØ­\n+{total_points} Ù†Ù‚Ø·Ø©",
                    "response": self.get_question(),
                    "points": total_points
                }

        return {
            "message": "âŒ Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©",
            "response": self._create_text_message("âŒ Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©"),
            "points": 0
        }
