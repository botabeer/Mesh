import random
from games.base import BaseGame
from config import Config


class LettersGame(BaseGame):
    def __init__(self, db, theme: str = "light"):
        super().__init__(db, theme)
        self.game_name = "حرف"
        
        self.questions_db = {
            "أ": [
                {"q": "من هو أول نبي؟", "a": ["آدم", "ادم"]},
                {"q": "ما هي عاصمة اليونان؟", "a": ["أثينا", "اثينا"]},
                {"q": "ما هي عاصمة الجزائر؟", "a": ["الجزائر"]},
                {"q": "من هو أول خليفة للمسلمين؟", "a": ["أبو بكر", "ابو بكر", "ابوبكر", "أبوبكر"]},
                {"q": "ما هي أكبر قارة في العالم؟", "a": ["آسيا", "اسيا"]}
            ],
            "ب": [
                {"q": "ما هي عاصمة العراق؟", "a": ["بغداد"]},
                {"q": "ما هي عاصمة الصين؟", "a": ["بكين"]},
                {"q": "ما هي عاصمة لبنان؟", "a": ["بيروت"]},
                {"q": "ما هي عاصمة ألمانيا؟", "a": ["برلين"]},
                {"q": "ما الحيوان المعروف بتزويدنا بالحليب واللحم؟", "a": ["بقرة"]}
            ],
            "ت": [
                {"q": "ما هي عاصمة تونس؟", "a": ["تونس"]},
                {"q": "ما هي عاصمة تايوان؟", "a": ["تايبيه", "تايبي"]},
                {"q": "ما هي عاصمة جورجيا؟", "a": ["تبليسي"]},
                {"q": "ما الحيوان الضخم الذي يعيش في المستنقعات؟", "a": ["تمساح"]},
                {"q": "ما الفاكهة التي تأتي بألوان مختلفة كالأحمر والأخضر؟", "a": ["تفاح"]}
            ],
            "ج": [
                {"q": "ما هي عاصمة جيبوتي؟", "a": ["جيبوتي"]},
                {"q": "ما المدينة السعودية على البحر الأحمر؟", "a": ["جدة", "جده"]},
                {"q": "ما الحيوان المعروف بلقب سفينة الصحراء؟", "a": ["جمل"]},
                {"q": "من الصحابي الذي قاد المسلمين المهاجرين إلى الحبشة؟", "a": ["جعفر"]},
                {"q": "ما الجهاز المستخدم لقياس شدة التيار الكهربائي؟", "a": ["جلفانومتر"]}
            ],
            "ح": [
                {"q": "ما المدينة السورية المشهورة بقلعتها التاريخية؟", "a": ["حلب"]},
                {"q": "ما المدينة السورية التي يمر بها نهر العاصي؟", "a": ["حماة", "حماه"]},
                {"q": "ما المدينة السعودية الواقعة في شمال المملكة؟", "a": ["حائل"]},
                {"q": "ما الركن الخامس من أركان الإسلام؟", "a": ["حج"]},
                {"q": "ما الحيوان العملاق الذي يتنفس الهواء ويعيش في المحيطات؟", "a": ["حوت"]}
            ],
            "د": [
                {"q": "ما هي عاصمة أيرلندا؟", "a": ["دبلن"]},
                {"q": "ما هي عاصمة سوريا؟", "a": ["دمشق"]},
                {"q": "ما المدينة الإماراتية الشهيرة بناطحات السحاب؟", "a": ["دبي"]},
                {"q": "ما هي عاصمة قطر؟", "a": ["دوحة", "الدوحة"]},
                {"q": "ما الحيوان الذي يعيش في القطب الشمالي؟", "a": ["دب قطبي", "دب"]}
            ],
            "ر": [
                {"q": "ما هي عاصمة إيطاليا؟", "a": ["روما"]},
                {"q": "ما الدولة الأكبر مساحة في العالم؟", "a": ["روسيا"]},
                {"q": "ما هي عاصمة آيسلندا؟", "a": ["ريكيافيك"]},
                {"q": "ما اسم العملة الرسمية في دولة قطر؟", "a": ["ريال قطري", "ريال"]},
                {"q": "من ابنة الرسول التي تزوجها عثمان بن عفان؟", "a": ["رقية"]}
            ],
            "س": [
                {"q": "ما الحيوان الزاحف البطيء ذو الصدفة الصلبة؟", "a": ["سلحفاة", "سلحفاه"]},
                {"q": "من الصحابي الذي أشار بحفر الخندق؟", "a": ["سلمان الفارسي", "سلمان"]},
                {"q": "ما هي عاصمة السويد؟", "a": ["ستوكهولم"]},
                {"q": "ما الحيوان الصغير الذي يعيش على الأشجار؟", "a": ["سنجاب"]},
                {"q": "ما الدولة العربية التي عاصمتها مسقط؟", "a": ["سلطنة عمان", "عمان"]}
            ],
            "ع": [
                {"q": "ما المادة الحلوة التي ينتجها النحل؟", "a": ["عسل"]},
                {"q": "ما العضو في جسم الإنسان الذي يستخدم للرؤية؟", "a": ["عين"]},
                {"q": "ما هي عاصمة الأردن؟", "a": ["عمان"]},
                {"q": "ما القدرة على التفكير والتحليل لدى الإنسان؟", "a": ["عقل"]},
                {"q": "ما الفاكهة التي تزرع في كروم؟", "a": ["عنب"]}
            ],
            "ف": [
                {"q": "ما الدولة الأوروبية التي عاصمتها هلسنكي؟", "a": ["فنلندا"]},
                {"q": "ما الدولة الأوروبية التي عاصمتها باريس؟", "a": ["فرنسا"]},
                {"q": "ما الحيوان البري الأكبر حجما في إفريقيا؟", "a": ["فيل"]},
                {"q": "ما الحيوان الأسرع في العدو بين السنوريات؟", "a": ["فهد"]},
                {"q": "ما الإمبراطورية التي امتدت في إيران قبل الإسلام؟", "a": ["فارس"]}
            ],
            "ق": [
                {"q": "ما الدولة العربية التي تقع على الخليج؟", "a": ["قطر"]},
                {"q": "ما هي عاصمة مصر؟", "a": ["قاهرة", "القاهرة"]},
                {"q": "ما المدينة الجزائرية التي تعرف بجسورها المعلقة؟", "a": ["قسنطينة"]},
                {"q": "ما القارة الأكبر من حيث المساحة والسكان؟", "a": ["آسيا", "اسيا"]},
                {"q": "ما الكائن البحري الهلامي؟", "a": ["قنديل البحر", "قنديل"]}
            ],
            "ك": [
                {"q": "ما هي عاصمة ماليزيا؟", "a": ["كوالالمبور"]},
                {"q": "ما هي عاصمة أفغانستان؟", "a": ["كابول"]},
                {"q": "ما هي عاصمة أوكرانيا؟", "a": ["كييف"]},
                {"q": "ما هي عاصمة أوغندا؟", "a": ["كمبالا"]},
                {"q": "ما البناء المقدس في مكة المكرمة؟", "a": ["كعبة", "الكعبة"]}
            ],
            "م": [
                {"q": "ما العضو في جسم الإنسان الذي يتحكم في الوظائف الحيوية؟", "a": ["مخ"]},
                {"q": "ما الشركة التي تصنع سيارات مرسيدس بنز؟", "a": ["مرسيدس"]},
                {"q": "ما العضو في جسم الإنسان الذي يساعد في التنسيق؟", "a": ["مخيخ"]},
                {"q": "ما الجهاز الذي يستخدم في الزراعة لحفر الأرض؟", "a": ["محراث"]},
                {"q": "ما العضو الذي يساعد في هضم الطعام؟", "a": ["معدة", "المعدة"]}
            ],
            "ن": [
                {"q": "ما أكبر نهر في العالم من حيث طول مجراه؟", "a": ["نيل", "النيل"]},
                {"q": "ما الطائر الذي يرمز إلى الحرية؟", "a": ["نسر"]},
                {"q": "ما الحيوان الذي يعتبر رمزا للقوة؟", "a": ["نمر"]},
                {"q": "ما الضوء الذي يشع من الشمس؟", "a": ["نور"]},
                {"q": "ما المادة المالية المستخدمة في المعاملات؟", "a": ["نقود"]}
            ],
            "ي": [
                {"q": "ما الفترة الزمنية التي تبلغ 24 ساعة؟", "a": ["يوم"]},
                {"q": "ما العضو في الجسم المستخدم للمس والإمساك؟", "a": ["يد"]},
                {"q": "ما الشعور بالثقة التامة دون شك؟", "a": ["يقين"]},
                {"q": "ما الاتجاه المعاكس لليمين؟", "a": ["يسار"]},
                {"q": "ما الدولة العربية الواقعة في جنوب شبه الجزيرة؟", "a": ["يمن", "اليمن"]}
            ]
        }
        
        self.letters = list(self.questions_db.keys())
        random.shuffle(self.letters)
        
        self.current_letter = None
        self.current_question_data = None
        self.used_questions = {letter: [] for letter in self.letters}

    def get_question(self):
        letter_idx = self.current_q % len(self.letters)
        self.current_letter = self.letters[letter_idx]
        
        available_questions = [
            q for i, q in enumerate(self.questions_db[self.current_letter])
            if i not in self.used_questions[self.current_letter]
        ]
        
        if not available_questions:
            self.used_questions[self.current_letter] = []
            available_questions = self.questions_db[self.current_letter]
        
        self.current_question_data = random.choice(available_questions)
        question_idx = self.questions_db[self.current_letter].index(self.current_question_data)
        self.used_questions[self.current_letter].append(question_idx)
        
        text = f"حرف: {self.current_letter}\n\n{self.current_question_data['q']}"
        hint = f"الإجابة تبدأ بحرف {self.current_letter}"
        
        return self.build_question_flex(text, hint)

    def check_answer(self, answer: str) -> bool:
        if not answer or not self.current_question_data:
            return False
        
        normalized = Config.normalize(answer)
        
        for correct_answer in self.current_question_data["a"]:
            normalized_correct = Config.normalize(correct_answer)
            if normalized == normalized_correct:
                return True
        
        return False
