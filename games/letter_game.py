import random
from games.base_game import BaseGame

class LetterGame(BaseGame):
    """لعبة الحروف - اسئلة تبدأ بحرف معين"""

    def __init__(self, line_bot_api, difficulty=3, theme="light"):
        super().__init__(line_bot_api, difficulty=difficulty, theme=theme)

        self.game_name = "حرف"
        self.supports_hint = True
        self.supports_reveal = True

        # بنك الاسئلة - 100 سؤال متنوع
        self.questions_db = {
            "ا": [
                {"q": "من هو اول نبي", "a": ["ادم", "آدم"]},
                {"q": "ما اطول نهر في افريقيا", "a": ["النيل"]},
                {"q": "ما هو العضو المسؤول عن ضخ الدم", "a": ["القلب"]},
                {"q": "ما اسم الكوكب الاحمر", "a": ["المريخ"]},
                {"q": "ما هي عاصمة الارجنتين", "a": ["بوينس ايرس"]},
            ],
            "ب": [
                {"q": "ما هي عاصمة العراق", "a": ["بغداد"]},
                {"q": "ما هي عاصمة الصين", "a": ["بكين"]},
                {"q": "ما اسم اطول سور في العالم", "a": ["سور الصين العظيم", "سور الصين"]},
                {"q": "ما اسم اكبر قارة في العالم", "a": ["اسيا"]},
                {"q": "ما المادة التي يصنع منها الزجاج", "a": ["الرمل"]},
            ],
            "ت": [
                {"q": "ما هي عاصمة تونس", "a": ["تونس"]},
                {"q": "ما هي عاصمة تركيا", "a": ["انقرة"]},
                {"q": "ما الجهاز المستخدم للاتصال", "a": ["الهاتف", "التلفون"]},
                {"q": "ما البحر الذي يفصل اوروبا عن افريقيا", "a": ["البحر المتوسط", "المتوسط"]},
                {"q": "ما اسم الطائر الذي لا يطير", "a": ["النعامة"]},
            ],
            "ج": [
                {"q": "ما هي عاصمة اليابان", "a": ["طوكيو"]},
                {"q": "ما الحيوان ملك الغابة", "a": ["الاسد"]},
                {"q": "ما الحيوان المعروف بسفينة الصحراء", "a": ["الجمل"]},
                {"q": "ما اسم اكبر محيط في العالم", "a": ["المحيط الهادئ", "الهادئ"]},
                {"q": "ما اليوم الاول في الاسبوع", "a": ["الاحد"]},
            ],
            "ح": [
                {"q": "ما المدينة السورية المشهورة بقلعتها", "a": ["حلب"]},
                {"q": "ما الحيوان المعروف ببطئه", "a": ["السلحفاة"]},
                {"q": "ما اسم عاصمة الاردن", "a": ["عمان"]},
                {"q": "ما اعلى جبل في العالم", "a": ["ايفرست", "افرست"]},
                {"q": "كم عدد حواس الانسان", "a": ["5", "خمسة"]},
            ],
            "خ": [
                {"q": "ما الخضار الاحمر الشهير", "a": ["الطماطم", "البندورة"]},
                {"q": "من هو خاتم الانبياء", "a": ["محمد"]},
                {"q": "ما اسم الحيوان الذي يعيش في البحر وله ثمانية اذرع", "a": ["الاخطبوط"]},
                {"q": "ما الفاكهة الخضراء المشهورة", "a": ["الخيار"]},
                {"q": "ما هو الخط العربي الاكثر شهرة", "a": ["النسخ", "الثلث"]},
            ],
            "د": [
                {"q": "ما العضو المسؤول عن ضخ الدم في الجسم", "a": ["القلب"]},
                {"q": "ما اسم العاصمة السورية", "a": ["دمشق"]},
                {"q": "ما الطائر الذي يطير ببطء", "a": ["الدجاجة"]},
                {"q": "ما اسم المدينة المنورة قديما", "a": ["يثرب"]},
                {"q": "ما الحيوان المفترس الذي يعيش في البحر", "a": ["القرش", "الدولفين"]},
            ],
            "ذ": [
                {"q": "ما المعدن الاصفر الثمين", "a": ["الذهب"]},
                {"q": "ما الحاسة التي نستخدمها للتذوق", "a": ["اللسان", "التذوق"]},
                {"q": "ما اسم الحيوان المعروف بذيله الطويل", "a": ["القرد"]},
                {"q": "ما الجزء الذي نستخدمه للاشارة", "a": ["الاصبع"]},
                {"q": "ما اسم الطعام المصنوع من اللحم المفروم", "a": ["الكفتة"]},
            ],
            "ر": [
                {"q": "ما هي عاصمة السعودية", "a": ["الرياض"]},
                {"q": "ما الشهر المبارك للمسلمين", "a": ["رمضان"]},
                {"q": "ما الحيوان المعروف بسرعته الفائقة", "a": ["الفهد"]},
                {"q": "ما اسم اطول نهر في اوروبا", "a": ["الفولغا"]},
                {"q": "ما اسم الفاكهة الصيفية الحمراء", "a": ["الرمان"]},
            ],
            "ز": [
                {"q": "ما النبات المعروف بزيته الصحي", "a": ["الزيتون"]},
                {"q": "ما الحيوان المخطط الافريقي", "a": ["الحمار الوحشي", "الزرافة"]},
                {"q": "ما الكوكب الاقرب للارض", "a": ["الزهرة"]},
                {"q": "ما اسم الفاكهة الخضراء الصغيرة", "a": ["الزيتون"]},
                {"q": "ما اللون الناتج عن خلط الاحمر والاصفر", "a": ["البرتقالي"]},
            ],
            "س": [
                {"q": "ما هي عاصمة السويد", "a": ["ستوكهولم"]},
                {"q": "ما الحيوان الزاحف ذو الصدفة", "a": ["السلحفاة"]},
                {"q": "من الصحابي الذي اشار بحفر الخندق", "a": ["سلمان الفارسي", "سلمان"]},
                {"q": "ما اسم الجهاز الذي يعرض الصور", "a": ["التلفاز"]},
                {"q": "كم عدد اجنحة النحلة", "a": ["4", "اربعة"]},
            ],
            "ش": [
                {"q": "ما المشروب الساخن المشهور", "a": ["الشاي"]},
                {"q": "ما الفصل البارد من السنة", "a": ["الشتاء"]},
                {"q": "ما اسم الكوكب الذي يضيء في الليل", "a": ["القمر"]},
                {"q": "ما الحيوان الذي له شوك على ظهره", "a": ["القنفذ"]},
                {"q": "ما اسم اللعبة المشهورة ذات المربعات", "a": ["الشطرنج"]},
            ],
            "ص": [
                {"q": "ما اول شهور الصيف", "a": ["يونيو", "حزيران"]},
                {"q": "ما الطائر الجارح المشهور", "a": ["الصقر"]},
                {"q": "ما اسم الوقت بين الظهر والمغرب", "a": ["العصر"]},
                {"q": "ما الفاكهة الصفراء المشهورة", "a": ["الموز"]},
                {"q": "كم عدد الصلوات المفروضة", "a": ["5", "خمسة"]},
            ],
            "ض": [
                {"q": "ما الحيوان المفترس الذي يعيش في افريقيا", "a": ["الضبع"]},
                {"q": "ما اسم الكلمة التي تنطق بالظاء والضاد", "a": ["الضاد"]},
                {"q": "ما اسم اللغة العربية", "a": ["لغة الضاد"]},
                {"q": "ما نوع الضوء الذي نراه من الشمس", "a": ["النهار"]},
                {"q": "ما الحيوان الذي يتغذى على اللحوم", "a": ["الضبع"]},
            ],
            "ط": [
                {"q": "ما المدينة المقدسة في السعودية", "a": ["مكة"]},
                {"q": "ما الطائر ذو الالوان الجميلة", "a": ["الطاووس"]},
                {"q": "ما اسم العاصمة اليابانية", "a": ["طوكيو"]},
                {"q": "ما الخضار الحمراء المستديرة", "a": ["الطماطم"]},
                {"q": "ما المهنة التي تعالج المرضى", "a": ["الطبيب"]},
            ],
            "ظ": [
                {"q": "ما الوقت الذي يأتي بعد العصر", "a": ["الظهر", "المغرب"]},
                {"q": "ما الحيوان الذي له ظهر محني", "a": ["الجمل"]},
                {"q": "ما اسم الوقت الذي تشرق فيه الشمس", "a": ["الصباح"]},
                {"q": "ما الشيء الذي يحمينا من الشمس", "a": ["الظل"]},
                {"q": "ما الحيوان الذي يخرج في الظلام", "a": ["الخفاش"]},
            ],
            "ع": [
                {"q": "ما هي عاصمة الاردن", "a": ["عمان"]},
                {"q": "ما الحيوان الصحراوي ذو السنام", "a": ["الجمل"]},
                {"q": "ما اسم الوجبة المسائية", "a": ["العشاء"]},
                {"q": "ما اكبر عضو في جسم الانسان", "a": ["الجلد"]},
                {"q": "ما المعدن الثمين الاصفر", "a": ["الذهب"]},
            ],
            "غ": [
                {"q": "ما اسم الحيوان المفترس الكبير", "a": ["الغوريلا"]},
                {"q": "ما الشيء الذي نتنفسه", "a": ["الهواء"]},
                {"q": "ما اسم الوقت بعد الظهر", "a": ["الغروب", "المساء"]},
                {"q": "ما الجهاز المستخدم لغسل الملابس", "a": ["الغسالة"]},
                {"q": "ما اسم الطعام الذي يصنع من القمح", "a": ["الخبز"]},
            ],
            "ف": [
                {"q": "ما الفاكهة الحمراء الصيفية", "a": ["الفراولة"]},
                {"q": "ما الحيوان المفترس السريع", "a": ["الفهد"]},
                {"q": "ما هي عاصمة فرنسا", "a": ["باريس"]},
                {"q": "ما الطائر الجميل ذو الالوان الزاهية", "a": ["الفراشة"]},
                {"q": "ما اسم المرأة الصالحة في القران", "a": ["مريم"]},
            ],
            "ق": [
                {"q": "ما هي عاصمة مصر", "a": ["القاهرة"]},
                {"q": "ما المشروب الساخن المر", "a": ["القهوة"]},
                {"q": "ما الكوكب الذي يضيء ليلا", "a": ["القمر"]},
                {"q": "ما الحيوان المفترس الذي يعيش في البحر", "a": ["القرش"]},
                {"q": "ما العضو الذي يضخ الدم", "a": ["القلب"]},
            ],
            "ك": [
                {"q": "ما المدينة المقدسة في السعودية", "a": ["مكة"]},
                {"q": "ما اسم الوعاء الذي نشرب فيه", "a": ["الكوب"]},
                {"q": "ما الاثاث الذي نجلس عليه", "a": ["الكرسي"]},
                {"q": "ما اسم الرياضة الاكثر شعبية", "a": ["كرة القدم", "الكرة"]},
                {"q": "كم عدد الكواكب في المجموعة الشمسية", "a": ["8", "ثمانية"]},
            ],
            "ل": [
                {"q": "ما هي عاصمة لبنان", "a": ["بيروت"]},
                {"q": "ما الفاكهة الصفراء الحامضة", "a": ["الليمون"]},
                {"q": "ما اسم الوقت الذي ننام فيه", "a": ["الليل"]},
                {"q": "ما العضو الذي نتذوق به", "a": ["اللسان"]},
                {"q": "ما اللون الناتج عن خلط الاحمر والازرق", "a": ["البنفسجي"]},
            ],
            "م": [
                {"q": "ما العضو المسؤول عن التفكير", "a": ["المخ", "الدماغ"]},
                {"q": "ما الشركة التي تصنع سيارات فاخرة", "a": ["مرسيدس"]},
                {"q": "ما المعدن الاصفر الثمين", "a": ["الذهب"]},
                {"q": "ما اسم عاصمة المغرب", "a": ["الرباط"]},
                {"q": "ما اكبر بحر مغلق في العالم", "a": ["بحر قزوين"]},
            ],
            "ن": [
                {"q": "ما اكبر نهر في العالم", "a": ["النيل"]},
                {"q": "ما الطائر رمز الحرية", "a": ["النسر"]},
                {"q": "ما الحيوان رمز القوة", "a": ["النمر"]},
                {"q": "ما اسم الكوكب الذي نعيش عليه", "a": ["الارض"]},
                {"q": "ما اسم عاصمة النرويج", "a": ["اوسلو"]},
            ],
            "ه": [
                {"q": "ما الجهاز الذي نتكلم به", "a": ["الهاتف"]},
                {"q": "ما الشيء الذي نتنفسه", "a": ["الهواء"]},
                {"q": "ما المدينة التي هاجر اليها النبي", "a": ["المدينة", "يثرب"]},
                {"q": "ما اسم اكبر محيط في العالم", "a": ["الهادئ"]},
                {"q": "ما البلد المشهور بالاهرامات", "a": ["مصر"]},
            ],
            "و": [
                {"q": "ما الزهرة الجميلة الملونة", "a": ["الوردة"]},
                {"q": "ما اسم الوقت بين الصباح والظهر", "a": ["الضحى"]},
                {"q": "ما اسم اليوم السادس من الاسبوع", "a": ["الجمعة"]},
                {"q": "ما الطائر الابيض الجميل", "a": ["الحمامة"]},
                {"q": "ما اللون المحايد", "a": ["الابيض", "الاسود"]},
            ],
            "ي": [
                {"q": "ما العضو الذي نمسك به الاشياء", "a": ["اليد"]},
                {"q": "ما اسم اول يوم في الاسبوع", "a": ["الاحد"]},
                {"q": "ما اسم المدينة التي هاجر اليها النبي", "a": ["يثرب", "المدينة"]},
                {"q": "ما الفاكهة الخضراء الحامضة", "a": ["الليمون"]},
                {"q": "ما البلد المشهور بالساموراي", "a": ["اليابان"]},
            ],
        }

        # تجهيز الحروف
        self.letters = list(self.questions_db.keys())
        random.shuffle(self.letters)

        # حماية used_questions ضد BaseGame
        self._ensure_used_questions()

        self.current_letter = None
        self.current_question_data = None

    # حماية used_questions
    def _ensure_used_questions(self):
        if not isinstance(self.used_questions, dict):
            self.used_questions = {letter: set() for letter in self.letters}

    def get_question(self):
        self._ensure_used_questions()

        if self.current_question >= self.questions_count:
            return self.end_game()

        # اختيار الحرف الحالي
        self.current_letter = self.letters[
            self.current_question % len(self.letters)
        ]

        # الحصول على الاسئلة المستخدمة لهذا الحرف
        used = self.used_questions.setdefault(self.current_letter, set())
        total = len(self.questions_db[self.current_letter])

        # البحث عن الاسئلة المتاحة
        available = [i for i in range(total) if i not in used]

        # اذا استخدمنا كل الاسئلة نعيد تهيئة القائمة
        if not available:
            used.clear()
            available = list(range(total))

        # اختيار سؤال عشوائي
        idx = random.choice(available)
        used.add(idx)

        # تعيين السؤال والاجابة
        self.current_question_data = self.questions_db[self.current_letter][idx]
        self.current_answer = self.current_question_data["a"]

        question_text = f"حرف: {self.current_letter}\n\n{self.current_question_data['q']}"

        return self.build_question_message(
            question_text,
            f"الاجابة تبدا بحرف {self.current_letter}",
        )

    def check_answer(self, user_answer, user_id, display_name):
        if not self.game_active or user_id in self.answered_users:
            return None

        normalized = self.normalize_text(user_answer)

        if normalized == "ايقاف":
            return self.handle_withdrawal(user_id, display_name)

        if self.supports_hint and normalized == "لمح":
            ans = self.current_answer[0]
            hint = f"يبدا بحرف: {ans[0]}\nعدد الحروف: {len(ans)}"
            return {"response": self.build_text_message(hint), "points": 0}

        if self.supports_reveal and normalized == "جاوب":
            self.previous_answer = " او ".join(self.current_answer)
            self.current_question += 1
            self.answered_users.clear()
            
            if self.current_question >= self.questions_count:
                return self.end_game()
            
            return {
                "response": self.get_question(),
                "points": 0,
                "next_question": True,
            }

        # التحقق من الاجابة
        for correct in self.current_answer:
            if normalized == self.normalize_text(correct):
                self.answered_users.add(user_id)
                points = self.add_score(user_id, display_name, 1)
                self.previous_answer = " او ".join(self.current_answer)
                self.current_question += 1
                self.answered_users.clear()

                if self.current_question >= self.questions_count:
                    return {"response": self.end_game()["response"], "points": points, "game_over": True}

                return {"response": self.get_question(), "points": points, "next_question": True}

        return None
